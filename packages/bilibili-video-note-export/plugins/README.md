# Vite æ’ä»¶é›†åˆ ğŸš€

è¿™ä¸ªç›®å½•åŒ…å«äº†é¡¹ç›®ä¸­ä½¿ç”¨çš„è‡ªå®šä¹‰ Vite æ’ä»¶ã€‚

## vite-plugin-main-hmr

### åŠŸèƒ½æè¿° ğŸ“‹

ä¸“é—¨å¤„ç† `main.ts` ç­‰å…¥å£æ–‡ä»¶çš„çƒ­æ¨¡å—æ›¿æ¢ï¼ˆHMRï¼‰ï¼Œé¿å…æ•´é¡µåˆ·æ–°ï¼Œæä¾›æ›´æµç•…çš„å¼€å‘ä½“éªŒã€‚é‡‡ç”¨ç±»ä¼¼ React Hook çš„è®¾è®¡æ¨¡å¼ï¼Œ`mount` å‡½æ•°è¿”å›æ¸…ç†å‡½æ•°ï¼Œå®ç°æ›´ä¼˜é›…çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

### æ ¸å¿ƒç‰¹æ€§ âœ¨

- **æ™ºèƒ½æ¨¡å—æ›¿æ¢** - ç²¾ç¡®æ§åˆ¶æ¨¡å—çš„æŒ‚è½½å’Œå¸è½½ï¼Œé¿å…é¡µé¢åˆ·æ–°
- **ä¾èµ–æ–‡ä»¶è¿½è¸ª** - è‡ªåŠ¨æ£€æµ‹å¹¶å¤„ç†ä¾èµ–æ–‡ä»¶ï¼ˆå¦‚ utils.tsï¼‰çš„æ›´æ–°
- **å‰¯ä½œç”¨æ¸…ç†** - è‡ªåŠ¨ç®¡ç†äº‹ä»¶ç›‘å¬å™¨å’Œå®šæ—¶å™¨ç­‰å‰¯ä½œç”¨
- **é”™è¯¯å¤„ç†** - HMR å¤±è´¥æ—¶ä¼˜é›…å›é€€åˆ°é¡µé¢åˆ·æ–°
- **è°ƒè¯•æ”¯æŒ** - å¯é€‰çš„è°ƒè¯•æ—¥å¿—ï¼Œæ–¹ä¾¿å¼€å‘æ—¶æ’æŸ¥é—®é¢˜
- **ç±»å‹å®‰å…¨** - å®Œæ•´çš„ TypeScript ç±»å‹æ”¯æŒ

### ä½¿ç”¨æ–¹æ³• ğŸ› ï¸

åœ¨ `vite.config.ts` ä¸­é…ç½®ï¼š

```typescript
import { vitePluginMainHmr } from './plugins/vite-plugin-main-hmr'

export default defineConfig({
  plugins: [
    vitePluginMainHmr({
      entry: 'src/main.ts', // å…¥å£æ–‡ä»¶è·¯å¾„
      debug: true // å¼€å‘æ—¶å¯ç”¨è°ƒè¯•æ—¥å¿—
    })
    // ... å…¶ä»–æ’ä»¶
  ]
})
```

### é…ç½®é€‰é¡¹ âš™ï¸

| é€‰é¡¹    | ç±»å‹      | é»˜è®¤å€¼          | æè¿°             |
| ------- | --------- | --------------- | ---------------- |
| `entry` | `string`  | `'src/main.ts'` | å…¥å£æ–‡ä»¶è·¯å¾„     |
| `debug` | `boolean` | `false`         | æ˜¯å¦å¯ç”¨è°ƒè¯•æ—¥å¿— |

### å·¥ä½œåŸç† ğŸ”§

1. **ä»£ç åˆ†æ** - æ’ä»¶ä¼šæ£€æµ‹å…¥å£æ–‡ä»¶ä¸­æ˜¯å¦å¯¼å‡ºäº† `mount` å‡½æ•°
2. **HMR æ³¨å…¥** - è‡ªåŠ¨æ³¨å…¥å¢å¼ºçš„ HMR ä»£ç ï¼Œæ›¿æ¢ Vite é»˜è®¤çš„é¡µé¢åˆ·æ–°è¡Œä¸º
3. **ä¾èµ–è¿½è¸ª** - ç›‘å¬å…¥å£æ–‡ä»¶åŠå…¶ä¾èµ–æ–‡ä»¶çš„å˜åŒ–ï¼Œç¡®ä¿ä»»ä½•ç›¸å…³æ›´æ–°éƒ½è§¦å‘è‡ªå®šä¹‰ HMR
4. **ç”Ÿå‘½å‘¨æœŸç®¡ç†** - åœ¨æ¨¡å—æ›´æ–°æ—¶å…ˆè°ƒç”¨ä¹‹å‰ä¿å­˜çš„æ¸…ç†å‡½æ•°ï¼Œç„¶åæ‰§è¡Œæ–°çš„ `mount` å‡½æ•°
5. **æ¸…ç†å‡½æ•°ç®¡ç†** - é€šè¿‡ `import.meta.hot.data` ä¿å­˜ `mount` å‡½æ•°è¿”å›çš„æ¸…ç†å‡½æ•°
6. **çŠ¶æ€ä¿æŒ** - ç»´æŠ¤æ¨¡å—æŒ‚è½½çŠ¶æ€ï¼Œç¡®ä¿æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œ

### é€‚ç”¨åœºæ™¯ ğŸ¯

- **Tampermonkey è„šæœ¬å¼€å‘** - éœ€è¦é¢‘ç¹è°ƒè¯•ä½†ä¸èƒ½ä¸¢å¤±é¡µé¢çŠ¶æ€
- **æµè§ˆå™¨æ‰©å±•å¼€å‘** - éœ€è¦ä¿æŒæ‰©å±•çš„è¿è¡ŒçŠ¶æ€
- **å•é¡µåº”ç”¨å¼€å‘** - éœ€è¦ç²¾ç¡®æ§åˆ¶ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„åœºæ™¯

### è§¦å‘æ¡ä»¶ ğŸ”„

æ’ä»¶ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè§¦å‘è‡ªå®šä¹‰ HMRï¼š

- âœ… **ç›´æ¥ä¿®æ”¹å…¥å£æ–‡ä»¶**ï¼ˆå¦‚ `main.ts`ï¼‰
- âœ… **ä¿®æ”¹ä¾èµ–æ–‡ä»¶**ï¼ˆå¦‚ `utils.ts`ã€`style.css` ç­‰è¢« `main.ts` å¯¼å…¥çš„æ–‡ä»¶ï¼‰
- âŒ **ä¿®æ”¹æ— å…³æ–‡ä»¶**ï¼ˆä¸è¢«å…¥å£æ–‡ä»¶ç›´æ¥æˆ–é—´æ¥å¯¼å…¥çš„æ–‡ä»¶ï¼‰

### æ³¨æ„äº‹é¡¹ âš ï¸

1. ç¡®ä¿ä½ çš„å…¥å£æ–‡ä»¶å¯¼å‡ºäº†åä¸º `mount` çš„å‡½æ•°
2. `mount` å‡½æ•°åº”è¯¥è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œç”¨äºæ¸…ç†æ‰€æœ‰å‰¯ä½œç”¨ï¼ˆäº‹ä»¶ç›‘å¬å™¨ã€å®šæ—¶å™¨ç­‰ï¼‰
3. æ¸…ç†å‡½æ•°ä¸­åº”è¯¥åŒ…å«å®Œæ•´çš„æ¸…ç†é€»è¾‘ï¼Œç¡®ä¿æ²¡æœ‰å†…å­˜æ³„æ¼
4. å»ºè®®åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨ `debug` é€‰é¡¹ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
5. å¦‚æœ HMR å¤±è´¥ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨å›é€€åˆ°é¡µé¢åˆ·æ–°

### ç¤ºä¾‹ä»£ç  ğŸ’¡

```typescript
// src/main.ts
export const mount = () => {
  // æŒ‚è½½é€»è¾‘
  const observer = new MutationObserver(callback)
  document.addEventListener('click', handleClick)

  console.log('æ¨¡å—å·²æŒ‚è½½')

  // è¿”å›æ¸…ç†å‡½æ•°
  return () => {
    // æ¸…ç†é€»è¾‘
    observer.disconnect()
    document.removeEventListener('click', handleClick)
    console.log('æ¨¡å—å·²æ¸…ç†')
  }
}

// åˆå§‹æŒ‚è½½
mount()
```

é€šè¿‡è¿™ä¸ªæ’ä»¶ï¼Œä½ å¯ä»¥äº«å—åˆ°æ›´æµç•…çš„å¼€å‘ä½“éªŒï¼Œæ— éœ€æ¯æ¬¡éƒ½é‡æ–°åŠ è½½æ•´ä¸ªé¡µé¢ï¼ğŸ‰
